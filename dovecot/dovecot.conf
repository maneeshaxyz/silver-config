# Minimal Dovecot Configuration - SASL Authentication Only
# This configuration provides only SASL authentication service for Postfix
# All mail delivery, storage, and retrieval is handled by Raven IMAP server

# Authentication service for Postfix SASL
service auth {
  unix_listener /var/spool/postfix/private/auth {
    mode = 0666
    user = dovecot
    group = dovecot
  }
}

# Disable plaintext auth (allow it since we're using TLS at the SMTP level)
disable_plaintext_auth = no

# Authentication mechanisms supported
auth_mechanisms = plain login oauthbearer xoauth2

# Only enable auth protocol (no imap, lmtp, or pop3 needed)
protocols =

# SSL/TLS Configuration (required for secure authentication)
ssl = required
ssl_cert = </etc/letsencrypt/live/${MAIL_DOMAIN}/fullchain.pem
ssl_key  = </etc/letsencrypt/live/${MAIL_DOMAIN}/privkey.pem

ssl_protocols = !SSLv2 !SSLv3
ssl_min_protocol = TLSv1.2
ssl_cipher_list = HIGH:!aNULL:!MD5

# Password database - using Lua script for API-based authentication
passdb {
  driver = lua
  args = file=/etc/dovecot/auth_api.lua blocking=yes
}

# User database - using Lua script for API-based user lookups
userdb {
  driver = lua
  args = file=/etc/dovecot/auth_api.lua blocking=yes
}

# Logging configuration
log_path = /dev/stderr
info_log_path = /dev/stderr
debug_log_path = /dev/stderr

# Authentication debugging (can be disabled in production)
auth_debug = yes
auth_debug_passwords = yes
auth_verbose = yes
auth_verbose_passwords = yes
